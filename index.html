<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Show do Milh√£o - Vers√£o Final (Corrigido)</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <style>
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background-color: #0c1a54; color: #ffffff; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; text-align: center; padding: 10px; }
        #start-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #0c1a54; display: flex; justify-content: center; align-items: center; z-index: 100; cursor: pointer; transition: opacity 0.5s; }
        #start-overlay p { font-size: 2em; color: #facc15; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        #mute-music-btn { position: fixed; top: 15px; right: 15px; background-color: rgba(255, 255, 255, 0.2); color: white; border: none; border-radius: 50%; width: 50px; height: 50px; font-size: 1.5em; cursor: pointer; z-index: 50; transition: background-color 0.3s; }
        #mute-music-btn:hover { background-color: rgba(255, 255, 255, 0.4); }
        #game-container { background-color: #1e3a8a; border-radius: 20px; padding: 20px; width: 100%; max-width: 900px; box-shadow: 0 10px 20px rgba(0,0,0,0.4); visibility: hidden; opacity: 0; transition: opacity 0.5s; }
        #start-screen { display: block; }
        #game-screen { display: none; }
        h1 { font-size: 2.5em; color: #facc15; margin-bottom: 10px; }
        #start-screen p { font-size: 1.2em; margin-bottom: 30px; }
        #subject-selection-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 20px; }
        .subject-btn { background-color: #facc15; color: #0c1a54; font-size: 1.2em; font-weight: bold; padding: 20px 15px; border: none; border-radius: 10px; cursor: pointer; transition: transform 0.2s, background-color 0.2s; }
        .subject-btn:hover { transform: scale(1.05); background-color: #f59e0b; }
        #main-content-area { display: flex; gap: 20px; flex-wrap: wrap; }
        #game-panel { flex: 2; display: flex; flex-direction: column; min-width: 300px; }
        #prize-ladder-panel { flex: 1; background-color: rgba(0,0,0,0.2); border-radius: 10px; padding: 15px; min-width: 200px; }
        #prize-ladder-panel h2 { margin-top: 0; color: #facc15; font-size: 1.5em; }
        #prize-ladder { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column-reverse; }
        .prize-item { background-color: #1e40af; padding: 8px; margin-bottom: 5px; border-radius: 5px; text-align: center; font-weight: bold; font-size: 1.1em; transition: all 0.3s ease; }
        .prize-item.achieved-prize { background-color: #22c55e; color: #ffffff; }
        .prize-item.current-prize { background-color: #f59e0b; color: #0c1a54; transform: scale(1.1); box-shadow: 0 0 15px #f59e0b; }
        #status-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; background-color: rgba(0,0,0,0.2); padding: 10px; border-radius: 10px; flex-wrap: wrap; gap: 10px; }
        #score, #question-counter { font-size: 1.1em; font-weight: bold; }
        #question-container { background-color: #2563eb; padding: 20px; border-radius: 10px; min-height: 100px; display: flex; justify-content: center; align-items: center; font-size: 1.6em; margin-bottom: 15px; }
        #answers-container { display: grid; grid-template-columns: 1fr; gap: 10px; flex-grow: 1; }
        .answer-btn { background-color: #1e40af; color: white; padding: 15px; border-radius: 10px; border: 2px solid #3b82f6; font-size: 1.1em; cursor: pointer; transition: background-color 0.3s, transform 0.2s; text-align: left; }
        .answer-btn:hover:not(:disabled) { background-color: #3b82f6; transform: scale(1.02); }
        .answer-btn:disabled { cursor: not-allowed; opacity: 0.7; }
        .answer-btn.correct { background-color: #22c55e; border-color: #16a34a; }
        .answer-btn.incorrect { background-color: #ef4444; border-color: #dc2626; }
        #feedback-container { margin-top: 15px; font-size: 1.4em; font-weight: bold; min-height: 40px; }
        #next-button { background-color: #facc15; color: #0c1a54; font-size: 1.2em; padding: 10px 25px; border: none; border-radius: 10px; cursor: pointer; margin-top: 10px; display: none; }
        #toggle-audio-button { background: none; border: none; font-size: 1.8em; cursor: pointer; color: white; }
        #help-buttons-container { display: flex; justify-content: center; gap: 15px; margin-top: 15px; }
        .help-btn { background-color: #7c3aed; color: white; border: none; padding: 10px 15px; font-size: 1em; font-weight: bold; border-radius: 8px; cursor: pointer; transition: background-color 0.2s; min-width: 120px; }
        .help-btn:hover:not(:disabled) { background-color: #9d5dff; }
        .help-btn:disabled { background-color: #585858; color: #ababab; cursor: not-allowed; }
        #shop-btn, #ranking-btn { background-color: #22c55e; color: white; font-size: 1.2em; font-weight: bold; padding: 15px; border: none; border-radius: 10px; cursor: pointer; transition: background-color 0.2s; margin-top: 20px; }
        #ranking-btn { background-color: #7c3aed; margin-top: 10px; }
        #shop-btn:hover { background-color: #16a34a; }
        #ranking-btn:hover { background-color: #9d5dff; }
        #coin-balance { font-size: 1.2em; font-weight: bold; color: #facc15; display: flex; align-items: center; gap: 5px; }
        #shop-modal, #ranking-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center; z-index: 110; }
        #shop-container, #ranking-container { background-color: #1e3a8a; padding: 30px; border-radius: 15px; box-shadow: 0 0 25px rgba(250, 204, 21, 0.5); width: 90%; max-width: 500px; text-align: center; border: 2px solid #facc15; }
        #shop-container h2, #ranking-container h2 { color: #facc15; margin-top: 0; }
        .shop-item { display: flex; justify-content: space-between; align-items: center; background-color: #0c1a54; padding: 15px; border-radius: 8px; margin-bottom: 10px; }
        .shop-item-name { font-size: 1.2em; }
        .buy-btn { background-color: #facc15; color: #0c1a54; font-weight: bold; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; transition: background-color 0.2s; }
        .buy-btn:hover { background-color: #f59e0b; }
        #close-shop-btn, #close-ranking-btn { background-color: #ef4444; color: white; margin-top: 20px; }
        #shop-coin-balance { margin-bottom: 20px; font-size: 1.2em; }
        #player-name-container { margin: 20px 0; }
        #player-name-input { padding: 12px; font-size: 1.1em; border-radius: 8px; border: 2px solid #3b82f6; background-color: #0c1a54; color: white; width: 80%; max-width: 400px; text-align: center; }
        #player-name-input::placeholder { color: #ccc; }
        #ranking-list { list-style: none; padding: 0; max-height: 300px; overflow-y: auto; text-align: left; }
        .ranking-item { display: flex; justify-content: space-between; padding: 10px; background-color: #0c1a54; border-radius: 5px; margin-bottom: 8px; font-size: 1.1em; }
        .ranking-item span:first-child { font-weight: bold; }
        .ranking-item span:last-child { color: #facc15; }
        #timer-container { position: relative; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; }
        #timer-visual { position: absolute; width: 100%; height: 100%; border-radius: 50%; background: conic-gradient(#facc15 calc(var(--progress, 100) * 1%), #3b82f6 0); transition: background 0.3s ease-out; }
        #timer-container.danger #timer-visual { background: conic-gradient(#ef4444 calc(var(--progress, 100) * 1%), #3b82f6 0); }
        #timer-text { font-size: 1.2em; font-weight: bold; color: #ffffff; z-index: 1; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUpFadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        .slide-up-fade-in { animation: slideUpFadeIn 0.5s ease-out forwards; opacity: 0; }
        #decision-buttons-container { display: flex; justify-content: center; gap: 20px; margin-top: 10px; }
        #stop-btn, #continue-btn { font-size: 1.2em; font-weight: bold; padding: 10px 25px; border: none; border-radius: 10px; cursor: pointer; color: white; transition: background-color 0.2s; }
        #stop-btn { background-color: #ef4444; }
        #stop-btn:hover { background-color: #dc2626; }
        #continue-btn { background-color: #22c55e; }
        #continue-btn:hover { background-color: #16a34a; }
        @media (max-width: 768px) { #main-content-area { flex-direction: column-reverse; } #question-container { font-size: 1.2em; min-height: 80px; } .answer-btn { font-size: 1em; padding: 12px; } }
    </style>
</head>
<body>

    <div id="start-overlay"><p>Clique em qualquer lugar para come√ßar</p></div>
    <button id="mute-music-btn">üéµ</button>

    <div id="game-container">
        <div id="start-screen">
            <h1>Show do Milh√£o</h1>
            <p>Escolha uma mat√©ria para come√ßar!</p>
            <div id="player-name-container"><input type="text" id="player-name-input" placeholder="Digite seu nome para jogar"></div>
            <div id="subject-selection-container">
                <button class="subject-btn" data-subject="matematica">Matem√°tica</button>
                <button class="subject-btn" data-subject="historia">Hist√≥ria</button>
                <button class="subject-btn" data-subject="geografia">Geografia</button>
                <button class="subject-btn" data-subject="portugues">Portugu√™s</button>
                <button class="subject-btn" data-subject="artes">Artes</button>
            </div>
            <button id="shop-btn">üè™ Loja</button>
            <button id="ranking-btn">üèÜ Ranking</button>
        </div>
        <div id="game-screen" style="display: none;">
            <div id="main-content-area">
                <div id="game-panel">
                    <div id="status-bar">
                        <div id="coin-balance">ü™ô 0</div>
                        <div id="score">Pr√™mio: R$ 0</div>
                        <div id="timer-container"><div id="timer-visual"></div><span id="timer-text">15</span></div>
                        <button id="toggle-audio-button">üîä</button>
                        <div id="question-counter">Pergunta 1 / 15</div>
                    </div>
                    <div id="question-container"></div>
                    <div id="answers-container"></div>
                    <div id="help-buttons-container">
                        <button class="help-btn" id="fifty-fifty-btn">üéì 50:50 (x0)</button>
                        <button class="help-btn" id="skip-btn">‚è© Pular (x0)</button>
                        <button class="help-btn" id="cards-btn">üÉè Cartas (x0)</button>
                    </div>
                    <div id="feedback-container"></div>
                    <button id="next-button">Pr√≥xima Pergunta</button>
                    <div id="decision-buttons-container" style="display: none;">
                        <button id="stop-btn">Parar</button>
                        <button id="continue-btn">Continuar</button>
                    </div>
                </div>
                <div id="prize-ladder-panel">
                    <h2>Pr√™mios</h2>
                    <ol id="prize-ladder"></ol>
                </div>
            </div>
        </div>
    </div>
    
    <div id="shop-modal" style="display: none;">
        <div id="shop-container">
            <h2>Loja de Ajudas</h2>
            <p id="shop-coin-balance">Seu saldo: ü™ô 0</p>
            <div id="shop-items-container">
                <div class="shop-item"><span class="shop-item-name">üéì Ajuda 50:50</span><button class="buy-btn" data-help="fiftyFifty">Comprar (50 ü™ô)</button></div>
                <div class="shop-item"><span class="shop-item-name">‚è© Pular Pergunta</span><button class="buy-btn" data-help="skip">Comprar (75 ü™ô)</button></div>
                <div class="shop-item"><span class="shop-item-name">üÉè Cartas</span><button class="buy-btn" data-help="cards">Comprar (40 ü™ô)</button></div>
            </div>
            <button id="close-shop-btn" class="buy-btn">Fechar</button>
        </div>
    </div>
    <div id="ranking-modal" style="display: none;">
        <div id="ranking-container">
            <h2>üèÜ Ranking dos Melhores</h2>
            <ol id="ranking-list"></ol>
            <button id="close-ranking-btn" class="buy-btn">Fechar</button>
        </div>
    </div>
    
    <audio id="musica-fundo" src="musica-fundo.mp3" loop></audio>
    <audio id="correct-sound" src="correct.mp3" preload="auto"></audio>
    <audio id="wrong-sound" src="wrong.mp3" preload="auto"></audio>
    <audio id="click-sound" src="click.mp3" preload="auto"></audio>
    <audio id="tick-sound" src="tick.mp3" loop preload="auto"></audio>

<script>
document.addEventListener('DOMContentLoaded', function() {

    // CORRIGIDO: Busca os elementos DEPOIS que o DOM est√° pronto.
    const elements = {
        startOverlay: document.getElementById('start-overlay'),
        gameContainer: document.getElementById('game-container'),
        startScreen: document.getElementById('start-screen'),
        gameScreen: document.getElementById('game-screen'),
        subjectSelectionContainer: document.getElementById('subject-selection-container'),
        score: document.getElementById('score'),
        questionCounter: document.getElementById('question-counter'),
        questionContainer: document.getElementById('question-container'),
        answersContainer: document.getElementById('answers-container'),
        feedbackContainer: document.getElementById('feedback-container'),
        nextButton: document.getElementById('next-button'),
        toggleAudioButton: document.getElementById('toggle-audio-button'),
        prizeLadder: document.getElementById('prize-ladder'),
        muteMusicBtn: document.getElementById('mute-music-btn'),
        musicaFundo: document.getElementById('musica-fundo'),
        fiftyFiftyBtn: document.getElementById('fifty-fifty-btn'),
        skipBtn: document.getElementById('skip-btn'),
        cardsBtn: document.getElementById('cards-btn'),
        coinBalance: document.getElementById('coin-balance'),
        shopBtn: document.getElementById('shop-btn'),
        shopModal: document.getElementById('shop-modal'),
        closeShopBtn: document.getElementById('close-shop-btn'),
        shopItemsContainer: document.getElementById('shop-items-container'),
        shopCoinBalance: document.getElementById('shop-coin-balance'),
        playerNameInput: document.getElementById('player-name-input'),
        rankingBtn: document.getElementById('ranking-btn'),
        rankingModal: document.getElementById('ranking-modal'),
        rankingList: document.getElementById('ranking-list'),
        closeRankingBtn: document.getElementById('close-ranking-btn'),
        timerContainer: document.getElementById('timer-container'),
        timerVisual: document.getElementById('timer-visual'),
        timerText: document.getElementById('timer-text'),
        correctSound: document.getElementById('correct-sound'),
        wrongSound: document.getElementById('wrong-sound'),
        clickSound: document.getElementById('click-sound'),
        tickSound: document.getElementById('tick-sound'),
        decisionButtonsContainer: document.getElementById('decision-buttons-container'),
        stopBtn: document.getElementById('stop-btn'),
        continueBtn: document.getElementById('continue-btn')
    };

    const gameState = {
        shuffledQuestions: [], currentQuestionIndex: 0, score: 0, isGameOver: false, isMusicMuted: false, isAudioEnabled: true,
        ptBrVoice: null, playerCoins: 100, helpInventory: { fiftyFifty: 1, skip: 1, cards: 1 }, playerName: '',
        timerInterval: null, timeLeft: 15
    };

    const prizeLevels = [0, 500, 1000, 2000, 3000, 5000, 10000, 20000, 30000, 50000, 75000, 100000, 200000, 500000, 1000000];
    const helpPrices = { fiftyFifty: 100, skip: 90, cards: 40 };
    const COINS_PER_CORRECT_ANSWER = 15;
    const TIMER_DURATION = 15;
    const safeHavens = [10000, 100000];
    let allQuestions = {};

    function saveProgress() { localStorage.setItem('showDoMilhaoProgress', JSON.stringify({ coins: gameState.playerCoins, inventory: gameState.helpInventory })); }
    function loadProgress() {
        const savedProgress = JSON.parse(localStorage.getItem('showDoMilhaoProgress'));
        if (savedProgress) {
            gameState.playerCoins = savedProgress.coins ?? 100;
            gameState.helpInventory = savedProgress.inventory ?? { fiftyFifty: 1, skip: 1, cards: 1 };
        }
    }

    async function initialSetup() {
        try {
            const response = await fetch('perguntas.json');
            if (!response.ok) throw new Error(`Erro HTTP! status: ${response.status}`);
            allQuestions = await response.json();
            enableGame();
        } catch (error) {
            console.error("ERRO DETALHADO ao carregar perguntas.json:", error);
            elements.gameContainer.innerHTML = `<h1 style="color:white; text-align: center;">ERRO GRAVE:<br>N√£o foi poss√≠vel carregar o arquivo de perguntas.<br><small style="font-size: 0.6em; color: #ffdddd;">Verifique o console (F12) para detalhes.<br>Poss√≠veis causas: Arquivo 'perguntas.json' ausente ou mal formatado, ou problema no Live Server.</small></h1>`;
            elements.gameContainer.style.visibility = 'visible';
            elements.gameContainer.style.opacity = '1';
        }
    }

    function enableGame() {
        loadProgress();
        updateCoinDisplay();
        updateHelpButtonsUI();
        setupEventListeners();
        speechSynthesis.onvoiceschanged = loadVoices;
        loadVoices();
        // O container do jogo ser√° revelado pelo clique no overlay
    }

    function setupEventListeners() {
        elements.startOverlay.addEventListener('click', () => {
            // Garantir que a m√∫sica toque ap√≥s intera√ß√£o do usu√°rio
            elements.musicaFundo.volume = 1.0;
            elements.musicaFundo.muted = false;
            elements.musicaFundo.play().then(() => {
                console.log('M√∫sica iniciada com sucesso');
            }).catch(e => {
                console.error('Erro ao reproduzir m√∫sica:', e);
                // Tentar novamente
                setTimeout(() => elements.musicaFundo.play().catch(console.error), 100);
            });
            if (speechSynthesis.speaking) speechSynthesis.cancel();
            speechSynthesis.speak(new SpeechSynthesisUtterance(''));
            elements.startOverlay.style.opacity = '0';
            setTimeout(() => { elements.startOverlay.style.display = 'none'; }, 500);
            elements.gameContainer.style.visibility = 'visible';
            elements.gameContainer.style.opacity = '1';
        }, { once: true });
        
        elements.muteMusicBtn.addEventListener('click', () => { 
            gameState.isMusicMuted = !gameState.isMusicMuted; 
            if (gameState.isMusicMuted) {
                elements.musicaFundo.pause();
            } else {
                elements.musicaFundo.play().catch(console.error);
            }
            elements.muteMusicBtn.textContent = gameState.isMusicMuted ? 'üîá' : 'üéµ'; 
        });
        elements.toggleAudioButton.addEventListener('click', () => { gameState.isAudioEnabled = !gameState.isAudioEnabled; elements.toggleAudioButton.textContent = gameState.isAudioEnabled ? 'üîä' : 'üîá'; if (!gameState.isAudioEnabled) { speechSynthesis.cancel(); elements.tickSound.pause(); }});
        elements.subjectSelectionContainer.addEventListener('click', (event) => { if(event.target.classList.contains('subject-btn')){ playClickSound(); startGame(event.target.dataset.subject); }});
        elements.nextButton.addEventListener('click', () => { playClickSound(); if (gameState.isGameOver) resetFullGame(); else { gameState.currentQuestionIndex++; showNextQuestion(); } });
        elements.fiftyFiftyBtn.addEventListener('click', () => { playClickSound(); useFiftyFifty(); });
        elements.skipBtn.addEventListener('click', () => { playClickSound(); useSkip(); });
        elements.cardsBtn.addEventListener('click', () => { playClickSound(); useCards(); });
        elements.shopBtn.addEventListener('click', () => { playClickSound(); elements.shopModal.style.display = 'flex'; });
        elements.closeShopBtn.addEventListener('click', () => { playClickSound(); elements.shopModal.style.display = 'none'; });
        elements.shopItemsContainer.addEventListener('click', (event) => { if (event.target.classList.contains('buy-btn')) { playClickSound(); buyHelp(event.target.dataset.help); }});
        elements.rankingBtn.addEventListener('click', () => { playClickSound(); displayRanking(); elements.rankingModal.style.display = 'flex'; });
        elements.closeRankingBtn.addEventListener('click', () => { playClickSound(); elements.rankingModal.style.display = 'none'; });
        elements.stopBtn.addEventListener('click', () => { playClickSound(); endGame(false); }); 
        elements.continueBtn.addEventListener('click', () => { playClickSound(); gameState.currentQuestionIndex++; showNextQuestion(); });
    }
    
    function loadVoices() { gameState.ptBrVoice = speechSynthesis.getVoices().find(voice => voice.lang === 'pt-BR' || voice.lang.startsWith('pt-')); }
    function speakText(text) { if (!gameState.isAudioEnabled || !gameState.ptBrVoice) return; const utterance = new SpeechSynthesisUtterance(text); utterance.voice = gameState.ptBrVoice; utterance.rate = 1.1; utterance.pitch = 1; speechSynthesis.speak(utterance); }
    function triggerConfetti() { confetti({ particleCount: 150, spread: 90, origin: { y: 0.6 } }); }
    function playClickSound() { 
        if (gameState.isAudioEnabled) { 
            elements.clickSound.currentTime = 0; 
            elements.clickSound.volume = 0.3;
            elements.clickSound.play().catch(e => console.log('Erro ao tocar som de clique:', e)); 
        } 
    }

    function startTimer() {
        gameState.timeLeft = TIMER_DURATION;
        elements.timerText.textContent = gameState.timeLeft;
        elements.timerContainer.classList.remove('danger');
        elements.timerVisual.style.setProperty('--progress', '100');
        gameState.timerInterval = setInterval(() => {
            gameState.timeLeft--;
            elements.timerText.textContent = gameState.timeLeft;
            const progressPercentage = (gameState.timeLeft / TIMER_DURATION) * 100;
            elements.timerVisual.style.setProperty('--progress', progressPercentage);
            if (gameState.timeLeft === 5 && gameState.isAudioEnabled) {
                elements.tickSound.volume = 0.3;
                elements.tickSound.play().catch(e => console.log('Erro ao tocar tick:', e));
            }
            if (gameState.timeLeft <= 5) elements.timerContainer.classList.add('danger');
            if (gameState.timeLeft <= 0) handleTimeUp();
        }, 1000);
    }

    function stopTimer() { clearInterval(gameState.timerInterval); elements.tickSound.pause(); elements.tickSound.currentTime = 0; }
    
    function handleTimeUp() {
        stopTimer();
        speakText("Tempo esgotado!");
        Array.from(elements.answersContainer.children).forEach(b => {
            b.disabled = true;
            if (b.textContent === gameState.shuffledQuestions[gameState.currentQuestionIndex]?.correctAnswer) b.classList.add('correct');
        });
        handleIncorrectAnswer();
    }

    function getRanking() { return JSON.parse(sessionStorage.getItem('showDoMilhaoRanking')) || []; }
    
    function saveScore() {
        if (!gameState.playerName || gameState.score === 0) return;
        
        // Salva no sessionStorage (local)
        const ranking = getRanking();
        ranking.push({ name: gameState.playerName, score: gameState.score });
        ranking.sort((a, b) => b.score - a.score);
        sessionStorage.setItem('showDoMilhaoRanking', JSON.stringify(ranking.slice(0, 10)));
        
        // Envia para o servidor (ranking ao vivo)
        sendScoreToServer(gameState.playerName, gameState.score);
    }
    
    function sendScoreToServer(name, score) {
        // Detecta se est√° rodando localmente ou no GitHub Pages
        const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        const serverUrl = isLocalhost ? 'http://localhost:3000/api/ranking' : null;
        
        // Se n√£o tiver servidor dispon√≠vel (GitHub Pages), apenas salva localmente
        if (!serverUrl) {
            console.log('Modo GitHub Pages: Ranking salvo apenas localmente');
            return;
        }
        
        // Tenta enviar para o servidor local
        fetch(serverUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ name, score })
        })
        .then(res => res.json())
        .then(data => {
            console.log('‚úì Pontua√ß√£o enviada para o ranking ao vivo!', data);
        })
        .catch(err => {
            console.log('Servidor de ranking n√£o dispon√≠vel (modo offline):', err);
        });
    }
    
    function displayRanking() {
        const ranking = getRanking();
        elements.rankingList.innerHTML = '';
        if (ranking.length === 0) {
            elements.rankingList.innerHTML = '<p>Nenhuma pontua√ß√£o registrada.</p>';
            return;
        }
        ranking.forEach((entry, index) => {
            const li = document.createElement('li');
            li.classList.add('ranking-item');
            li.innerHTML = `<span>${index + 1}. ${entry.name}</span><span>R$ ${entry.score.toLocaleString('pt-BR')}</span>`;
            elements.rankingList.appendChild(li);
        });
    }

    function renderPrizeLadder() {
        elements.prizeLadder.innerHTML = '';
        if (!gameState.shuffledQuestions || gameState.shuffledQuestions.length === 0) return; 
        const relevantPrizeLevels = prizeLevels.slice(1, gameState.shuffledQuestions.length + 1);
        relevantPrizeLevels.forEach((prize, index) => {
            const li = document.createElement('li');
            li.textContent = `R$ ${prize.toLocaleString('pt-BR')}`;
            li.classList.add('prize-item');
            li.dataset.level = index;
            elements.prizeLadder.appendChild(li);
        });
    }
    
    function updatePrizeLadderHighlight() {
        const prizeItems = document.querySelectorAll('.prize-item');
        let achievedLevel = -1;
        for (let i = 0; i < gameState.currentQuestionIndex; i++) {
             if (prizeLevels[i + 1] <= gameState.score) {
                 achievedLevel = i;
             }
        }
        prizeItems.forEach(item => {
            const itemLevel = parseInt(item.dataset.level);
            item.classList.remove('current-prize', 'achieved-prize');
            if (itemLevel <= achievedLevel) {
                item.classList.add('achieved-prize');
            }
        });
        if (!gameState.isGameOver) {
            const currentPrizeItem = elements.prizeLadder.querySelector(`.prize-item[data-level='${gameState.currentQuestionIndex}']`);
            if (currentPrizeItem) {
                currentPrizeItem.classList.add('current-prize');
            }
        }
    }

    function shuffle(array) { const newArray = [...array]; for (let i = newArray.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [newArray[i], newArray[j]] = [newArray[j], newArray[i]]; } return newArray; }

    function startGame(subject) {
        if (!allQuestions || !allQuestions[subject]) { 
            console.error(`Mat√©ria "${subject}" n√£o encontrada ou perguntas n√£o carregadas.`);
            alert("Erro: Perguntas para esta mat√©ria n√£o foram carregadas. Verifique o console.");
            return;
        }
        gameState.playerName = elements.playerNameInput.value.trim();
        if (!gameState.playerName) { alert("Por favor, digite seu nome!"); elements.playerNameInput.focus(); return; }
        elements.musicaFundo.volume = 0.2;
        gameState.isGameOver = false;
        elements.startScreen.style.display = 'none';
        elements.gameScreen.style.display = 'block';
        gameState.shuffledQuestions = shuffle([...allQuestions[subject]]); 
        renderPrizeLadder(); 
        gameState.currentQuestionIndex = 0;
        gameState.score = 0;
        elements.nextButton.style.display = 'none';
        updateHelpButtonsUI();
        showNextQuestion();
    }

    function showNextQuestion() {
        resetStateForNewQuestion();
        if (gameState.currentQuestionIndex >= gameState.shuffledQuestions.length) { endGame(true); return; }
        updatePrizeLadderHighlight();
        updateStatus();
        const currentQuestion = gameState.shuffledQuestions[gameState.currentQuestionIndex];
        elements.questionContainer.textContent = currentQuestion.question;
        elements.questionContainer.classList.add('fade-in'); 
        speechSynthesis.cancel();
        let textToSpeak = `Valendo ${prizeLevels[gameState.currentQuestionIndex + 1]?.toLocaleString('pt-BR') ?? 'o pr√™mio m√°ximo'} reais. ${currentQuestion.question}.`; 
        const shuffledAnswers = shuffle([...currentQuestion.answers]); 
        shuffledAnswers.forEach((answer, index) => {
            const button = document.createElement('button');
            button.textContent = answer;
            button.classList.add('answer-btn', 'slide-up-fade-in'); 
            button.style.animationDelay = `${index * 0.1}s`; 
            button.addEventListener('click', () => selectAnswer(button, answer));
            elements.answersContainer.appendChild(button);
            textToSpeak += ` Alternativa ${['A', 'B', 'C', 'D'][index]}: ${answer}.`;
        });
        speakText(textToSpeak);
        startTimer();
        if (gameState.currentQuestionIndex === gameState.shuffledQuestions.length - 1) { 
            elements.feedbackContainer.textContent = "Pergunta do Milh√£o! Sem ajudas!"; 
            speakText("Pergunta do Milh√£o! Sem ajudas! Boa sorte!"); 
            [elements.fiftyFiftyBtn, elements.skipBtn, elements.cardsBtn].forEach(btn => btn.disabled = true); 
        }
    }

    function selectAnswer(selectedButton, selectedAnswer) {
        stopTimer();
        speechSynthesis.cancel();
        [elements.fiftyFiftyBtn, elements.skipBtn, elements.cardsBtn].forEach(btn => btn.disabled = true);
        const correctAnswer = gameState.shuffledQuestions[gameState.currentQuestionIndex]?.correctAnswer; 
        Array.from(elements.answersContainer.children).forEach(b => { 
            b.disabled = true; 
            if (correctAnswer && b.textContent === correctAnswer) b.classList.add('correct'); 
        });
        if (correctAnswer && selectedAnswer === correctAnswer) handleCorrectAnswer();
        else { selectedButton.classList.add('incorrect'); handleIncorrectAnswer(); }
    }

    function handleCorrectAnswer() {
        speakText("Resposta Certa!");
        if (gameState.isAudioEnabled) {
            elements.correctSound.currentTime = 0;
            elements.correctSound.volume = 0.5;
            elements.correctSound.play().catch(e => console.log("Erro som correto:", e));
        }
        triggerConfetti();
        gameState.score = prizeLevels[gameState.currentQuestionIndex + 1] ?? gameState.score; 
        gameState.playerCoins += COINS_PER_CORRECT_ANSWER;
        saveProgress();
        elements.feedbackContainer.textContent = `+${COINS_PER_CORRECT_ANSWER} ü™ô`;
        elements.feedbackContainer.style.color = '#facc15';
        updateStatus();
        updatePrizeLadderHighlight();
        if (safeHavens.includes(gameState.score) && gameState.currentQuestionIndex < gameState.shuffledQuestions.length - 1) {
            elements.feedbackContainer.textContent = `Voc√™ garantiu R$ ${gameState.score.toLocaleString('pt-BR')}! Deseja parar ou continuar?`;
            elements.stopBtn.textContent = `Parar (Levar R$ ${gameState.score.toLocaleString('pt-BR')})`;
            elements.decisionButtonsContainer.style.display = 'flex';
            elements.nextButton.style.display = 'none';
        } else if (gameState.currentQuestionIndex >= gameState.shuffledQuestions.length - 1) {
            setTimeout(() => endGame(true), 1500);
        } else {
            elements.nextButton.style.display = 'block';
            elements.decisionButtonsContainer.style.display = 'none';
        }
    }
    
    function handleIncorrectAnswer() { 
        if (gameState.isAudioEnabled) {
            elements.wrongSound.currentTime = 0;
            elements.wrongSound.volume = 0.5;
            elements.wrongSound.play().catch(e => console.log("Erro som errado:", e));
        }
        const correctAnswer = gameState.shuffledQuestions[gameState.currentQuestionIndex]?.correctAnswer; 
        speakText(`Errado!`); 
        setTimeout(() => endGame(false, correctAnswer), 2500); 
    }
    
    function endGame(hasWon, correctAnswer = '') {
        gameState.isGameOver = true;
        stopTimer();
        let endMessage = 'FIM DE JOGO!';
        if (hasWon && gameState.shuffledQuestions.length > 0) { 
             const maxPrize = prizeLevels[gameState.shuffledQuestions.length] ?? prizeLevels[prizeLevels.length -1]; 
             gameState.score = maxPrize; 
             endMessage = `PARAB√âNS! VOC√ä GANHOU R$ ${maxPrize.toLocaleString('pt-BR')}!`;
             setTimeout(() => { confetti({ particleCount: 400, spread: 180, ticks: 100, origin: { y: 0.5 } }); }, 500);
        }
        updatePrizeLadderHighlight();
        document.querySelectorAll('.prize-item').forEach(item => item.classList.remove('current-prize'));
        elements.questionContainer.textContent = endMessage;
        let finalMessageHTML = `<p style="font-size: 1.5em; text-align: center;">Voc√™ terminou com R$ ${gameState.score.toLocaleString('pt-BR')}</p>`;
        if (!hasWon && correctAnswer) { finalMessageHTML += `<p style="font-size: 1.1em; text-align: center; margin-top: 15px;">A resposta correta era: <strong>${correctAnswer}</strong></p>`; }
        elements.answersContainer.innerHTML = finalMessageHTML;
        speakText(`${endMessage}. Voc√™ terminou com R$ ${gameState.score.toLocaleString('pt-BR')}.`);
        saveScore();
        elements.nextButton.textContent = 'Jogar Novamente';
        elements.nextButton.style.display = 'block';
        elements.decisionButtonsContainer.style.display = 'none';
    }

    function resetFullGame() {
        elements.musicaFundo.volume = 1.0;
        elements.gameScreen.style.display = 'none';
        elements.startScreen.style.display = 'block';
    }
    
    function useFiftyFifty() {
        if (gameState.helpInventory.fiftyFifty <= 0) return;
        gameState.helpInventory.fiftyFifty--;
        saveProgress();
        updateHelpButtonsUI();
        elements.fiftyFiftyBtn.disabled = true;
        speakText("Ok, eliminando duas alternativas...");
        const { correctAnswer, answers } = gameState.shuffledQuestions[gameState.currentQuestionIndex];
        const incorrectAnswers = shuffle(answers.filter(a => a !== correctAnswer));
        Array.from(elements.answersContainer.children).forEach(button => {
            if (button.textContent === incorrectAnswers[0] || button.textContent === incorrectAnswers[1]) {
                button.style.opacity = '0.5';
                button.disabled = true;
            }
        });
    }

    function useSkip() {
        if (gameState.helpInventory.skip <= 0) return;
        stopTimer();
        gameState.helpInventory.skip--;
        saveProgress();
        updateHelpButtonsUI();
        speakText("Pergunta pulada!");
        gameState.currentQuestionIndex++;
        setTimeout(() => showNextQuestion(), 1000);
    }

    function useCards() {
        if (gameState.helpInventory.cards <= 0) return;
        gameState.helpInventory.cards--;
        saveProgress();
        updateHelpButtonsUI();
        elements.cardsBtn.disabled = true;
        const { correctAnswer, answers } = gameState.shuffledQuestions[gameState.currentQuestionIndex];
        let suggestion = (Math.random() < 0.7) ? correctAnswer : shuffle(answers.filter(a => a !== correctAnswer))[0];
        elements.feedbackContainer.textContent = `As cartas sugerem: "${suggestion}"`;
        speakText(`As cartas sugerem: ${suggestion}`);
    }

    function updateCoinDisplay() {
        const coinText = `ü™ô ${gameState.playerCoins}`;
        if(elements.coinBalance) elements.coinBalance.textContent = coinText;
        if(elements.shopCoinBalance) elements.shopCoinBalance.textContent = `Seu saldo: ${coinText}`;
    }

    function updateHelpButtonsUI() {
        if(elements.fiftyFiftyBtn) elements.fiftyFiftyBtn.textContent = `üéì 50:50 (x${gameState.helpInventory.fiftyFifty})`;
        if(elements.skipBtn) elements.skipBtn.textContent = `‚è© Pular (x${gameState.helpInventory.skip})`;
        if(elements.cardsBtn) elements.cardsBtn.textContent = `üÉè Cartas (x${gameState.helpInventory.cards})`;
        if(elements.fiftyFiftyBtn) elements.fiftyFiftyBtn.disabled = gameState.helpInventory.fiftyFifty <= 0;
        if(elements.skipBtn) elements.skipBtn.disabled = gameState.helpInventory.skip <= 0 || (gameState.shuffledQuestions.length > 0 && gameState.currentQuestionIndex === gameState.shuffledQuestions.length - 1);
        if(elements.cardsBtn) elements.cardsBtn.disabled = gameState.helpInventory.cards <= 0;
    }

    function buyHelp(helpType) {
        const price = helpPrices[helpType];
        if (gameState.playerCoins >= price) {
            gameState.playerCoins -= price;
            gameState.helpInventory[helpType]++;
            saveProgress();
            updateCoinDisplay();
            updateHelpButtonsUI();
            alert(`Voc√™ comprou uma ajuda!`);
        } else {
            alert("Moedas insuficientes!");
        }
    }

    function resetStateForNewQuestion() {
        stopTimer();
        elements.timerText.textContent = TIMER_DURATION;
        elements.timerContainer.classList.remove('danger');
        if (elements.timerVisual) elements.timerVisual.style.setProperty('--progress', '100');
        elements.answersContainer.innerHTML = '';
        elements.feedbackContainer.textContent = '';
        elements.nextButton.style.display = 'none';
        elements.decisionButtonsContainer.style.display = 'none';
        elements.questionContainer.classList.remove('fade-in');
        updateHelpButtonsUI();
    }

    function updateStatus() {
        elements.score.textContent = `Pr√™mio: R$ ${gameState.score.toLocaleString('pt-BR')}`;
        elements.questionCounter.textContent = gameState.shuffledQuestions.length > 0 ? `Pergunta ${gameState.currentQuestionIndex + 1} / ${gameState.shuffledQuestions.length}` : 'Carregando...'; 
        updateCoinDisplay();
    }
    
    initialSetup(); // Inicia o carregamento das perguntas
});
</script>

<div vw class="enabled"></div>
<script src="https://vlibras.gov.br/app/vlibras-plugin.js"></script>
<script>new window.VLibras.Widget('https://vlibras.gov.br/app');</script>
</body>
</html>

